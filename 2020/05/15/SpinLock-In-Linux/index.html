<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>SpinLock In Linux | BeeCaffe&#39;s Personal Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="header1#include&lt;pthread.h&gt; categorypthread_spinlock_t pthread_spin_init pthread_spin_destroy pthread_spin_lock pthread_spin_trylock pthread_spin_unlockcode pthread_spinlock_t 123&#x2F;&#x2F;initializes me">
<meta property="og:type" content="article">
<meta property="og:title" content="SpinLock In Linux">
<meta property="og:url" content="http://yoursite.com/2020/05/15/SpinLock-In-Linux/index.html">
<meta property="og:site_name" content="BeeCaffe&#39;s Personal Blogs">
<meta property="og:description" content="header1#include&lt;pthread.h&gt; categorypthread_spinlock_t pthread_spin_init pthread_spin_destroy pthread_spin_lock pthread_spin_trylock pthread_spin_unlockcode pthread_spinlock_t 123&#x2F;&#x2F;initializes me">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-05-15T14:30:05.000Z">
<meta property="article:modified_time" content="2020-05-15T14:30:28.693Z">
<meta property="article:author" content="BeeCaffe">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="BeeCaffe&#39;s Personal Blogs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">BeeCaffe&#39;s Personal Blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-SpinLock-In-Linux" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/15/SpinLock-In-Linux/" class="article-date">
  <time datetime="2020-05-15T14:30:05.000Z" itemprop="datePublished">2020-05-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SpinLock In Linux
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="header"><a href="#header" class="headerlink" title="header"></a>header</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="category"><a href="#category" class="headerlink" title="category"></a>category</h2><p><a href="#pthread_spinlock_t">pthread_spinlock_t</a></p>
<p><a href="#pthread_spin_init">pthread_spin_init</a></p>
<p><a href="#pthread_spin_destroy">pthread_spin_destroy</a></p>
<p><a href="#pthread_spin_lock">pthread_spin_lock</a></p>
<p><a href="#pthread_spin_trylock">pthread_spin_trylock</a></p>
<p><a href="#pthread_spin_unlock">pthread_spin_unlock</a><br><a href="#code">code</a></p>
<h2 id="pthread-spinlock-t"><a href="#pthread-spinlock-t" class="headerlink" title="pthread_spinlock_t"></a>pthread_spinlock_t</h2><hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//initializes method</span></span><br><span class="line"><span class="keyword">pthread_spinlock_t</span> spinlock;</span><br><span class="line">pthread_spin_init(&amp;spinlock,<span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>
<h2 id="pthread-spin-init"><a href="#pthread-spin-init" class="headerlink" title="pthread_spin_init"></a>pthread_spin_init</h2><hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_init</span><span class="params">(<span class="keyword">pthread_spinlock_t</span> *lock,<span class="keyword">int</span> pshared)</span></span>;</span><br><span class="line">args:</span><br><span class="line">    -lock: the spinlock type in linux</span><br><span class="line">    -pshared: </span><br><span class="line">        -PTHREAD_PROCESS_PRIVATE:spinlock can only be operated by the threads in the same process.</span><br><span class="line">        -PTHREAD_PROCESS_SHARED:spinlock can be operated by any thread in any process.</span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">    successed: <span class="number">0</span></span><br><span class="line">    error: Exxx</span><br></pre></td></tr></table></figure>
<h2 id="pthread-spin-destroy"><a href="#pthread-spin-destroy" class="headerlink" title="pthread_spin_destroy"></a>pthread_spin_destroy</h2><hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_destroy</span><span class="params">(<span class="keyword">pthread_spinlock_t</span> *lock)</span></span>;</span><br><span class="line">args:</span><br><span class="line">   -lock: the spinlock type in linux</span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">   successed: <span class="number">0</span></span><br><span class="line">   error: Exxx</span><br></pre></td></tr></table></figure>
<h2 id="pthread-spin-lock"><a href="#pthread-spin-lock" class="headerlink" title="pthread_spin_lock"></a>pthread_spin_lock</h2><hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_lock</span><span class="params">(<span class="keyword">pthread_spinlock_t</span> *lock)</span></span>;</span><br><span class="line"> args:</span><br><span class="line">    -lock: the spinlock type in linux</span><br><span class="line"> <span class="keyword">return</span>:</span><br><span class="line">    successed: <span class="number">0</span></span><br><span class="line">    error: Exxx</span><br></pre></td></tr></table></figure>
<h2 id="pthread-spin-trylock"><a href="#pthread-spin-trylock" class="headerlink" title="pthread_spin_trylock"></a>pthread_spin_trylock</h2><hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_trylock</span><span class="params">(<span class="keyword">pthread_spinlock_t</span> *lock)</span></span></span><br><span class="line"><span class="function"> args:</span></span><br><span class="line">    -lock: the spinlock type in linux</span><br><span class="line"> <span class="keyword">return</span>:</span><br><span class="line">    successed: <span class="number">0</span></span><br><span class="line">    error: Exxx</span><br></pre></td></tr></table></figure>
<h2 id="pthread-spin-unlock"><a href="#pthread-spin-unlock" class="headerlink" title="pthread_spin_unlock"></a>pthread_spin_unlock</h2><hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_unlock</span><span class="params">(<span class="keyword">pthread_spinlock_t</span> *lock)</span></span>;</span><br><span class="line">args:</span><br><span class="line">   -lock: the spinlock type in linux</span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">   successed: <span class="number">0</span></span><br><span class="line">   error: Exxx</span><br></pre></td></tr></table></figure>
<h2 id="code"><a href="#code" class="headerlink" title="code"></a>code</h2><hr>
<ul>
<li><p><strong>producer and comsumer model 1: N-1</strong> In this model, we build a class, called CritialZone, where we have a pool to write and read (produce and consume). In this model, we simplely create 10 threads as producer to produce data. After pool is full, we call consumer to read all data in one time.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CriticalZone</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">pthread_spinlock_t</span> s_mutex;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; s_pool;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> s_size;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> s_cur;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> s_val;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">pthread_spinlock_t</span> CriticalZone::s_mutex;</span><br><span class="line"><span class="keyword">int</span> CriticalZone::s_size=<span class="number">1024</span>;</span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; CriticalZone::s_pool;</span><br><span class="line"><span class="keyword">int</span> CriticalZone::s_cur=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> CriticalZone::s_val=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">consumer</span><span class="params">(<span class="keyword">void</span>*)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;CriticalZone::s_size;++i)&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"consuming data: "</span>&lt;&lt;CriticalZone::s_pool[CriticalZone::s_cur]&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        CriticalZone::s_cur--;</span><br><span class="line">        CriticalZone::s_pool.pop_back();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">producer</span><span class="params">(<span class="keyword">void</span>*)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        pthread_spin_lock(&amp;CriticalZone::s_mutex);</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"thread_"</span>&lt;&lt;pthread_self()&lt;&lt;<span class="string">" is writing value:"</span>&lt;&lt;CriticalZone::s_val&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">if</span>(CriticalZone::s_cur&gt;=CriticalZone::s_size)&#123;</span><br><span class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">"pool is full"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">            pthread_spin_unlock(&amp;CriticalZone::s_mutex);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CriticalZone::s_pool.push_back(CriticalZone::s_val);</span><br><span class="line">        CriticalZone::s_val++;</span><br><span class="line">        CriticalZone::s_cur++;</span><br><span class="line">        pthread_spin_unlock(&amp;CriticalZone::s_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">pthread_t</span>&gt; <span class="title">tids</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">    pthread_spin_init(&amp;CriticalZone::s_mutex,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pthread_create(&amp;tids[i],<span class="literal">nullptr</span>,producer,<span class="literal">nullptr</span>))&#123;</span><br><span class="line">            assert(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pthread_join(tids[i],<span class="literal">nullptr</span>))&#123;</span><br><span class="line">            assert(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">if</span>(pthread_create(&amp;tid,<span class="literal">nullptr</span>,consumer,<span class="literal">nullptr</span>))&#123;</span><br><span class="line">        assert(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pthread_join(tid,<span class="literal">nullptr</span>))&#123;</span><br><span class="line">        assert(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"main end!"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>producer and consumer model 2: N-1</strong> In this model, we create 10 threads to write and one threads to read. When there is no data in the pool, the consumer should recurrently wait for the data, util the pool is not empty.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CriticalZone</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">pthread_spinlock_t</span> s_mutex;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; s_pool;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> s_size;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> s_cur;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> s_val;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">pthread_spinlock_t</span> CriticalZone::s_mutex;</span><br><span class="line"><span class="keyword">int</span> CriticalZone::s_size=<span class="number">1024</span>;</span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; CriticalZone::s_pool;</span><br><span class="line"><span class="keyword">int</span> CriticalZone::s_cur=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> CriticalZone::s_val=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consume_wait</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        pthread_spin_lock(&amp;CriticalZone::s_mutex);</span><br><span class="line">        <span class="keyword">if</span>(i&lt;CriticalZone::s_cur)&#123;</span><br><span class="line">            pthread_spin_unlock(&amp;CriticalZone::s_mutex);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pthread_spin_unlock(&amp;CriticalZone::s_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">consumer</span><span class="params">(<span class="keyword">void</span>*)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;CriticalZone::s_size;++i)&#123;</span><br><span class="line">        consume_wait(i);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"consuming data: "</span>&lt;&lt;i&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">producer</span><span class="params">(<span class="keyword">void</span>*)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        pthread_spin_lock(&amp;CriticalZone::s_mutex);</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"thread_"</span>&lt;&lt;pthread_self()&lt;&lt;<span class="string">" is writing value:"</span>&lt;&lt;CriticalZone::s_val&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">if</span>(CriticalZone::s_cur&gt;=CriticalZone::s_size)&#123;</span><br><span class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">"pool is full"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">            pthread_spin_unlock(&amp;CriticalZone::s_mutex);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CriticalZone::s_pool.push_back(CriticalZone::s_val);</span><br><span class="line">        CriticalZone::s_val++;</span><br><span class="line">        CriticalZone::s_cur++;</span><br><span class="line">        pthread_spin_unlock(&amp;CriticalZone::s_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">pthread_t</span>&gt; <span class="title">tids</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">    pthread_spin_init(&amp;CriticalZone::s_mutex,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pthread_create(&amp;tids[i],<span class="literal">nullptr</span>,producer,<span class="literal">nullptr</span>))&#123;</span><br><span class="line">            assert(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">if</span>(pthread_create(&amp;tid,<span class="literal">nullptr</span>,consumer,<span class="literal">nullptr</span>))&#123;</span><br><span class="line">        assert(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pthread_join(tids[i],<span class="literal">nullptr</span>))&#123;</span><br><span class="line">            assert(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pthread_join(tid,<span class="literal">nullptr</span>))&#123;</span><br><span class="line">        assert(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"main end!"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><strong>producer and consumer model 3: N-N</strong> In this model, we create 10 threads to write and 10 threads to read. when and only when, there are on writers or readers writing or reading writer and reader can write and read. That is to say, lock is monopolized by one object.<pre><code class="cc">
</code></pre>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/15/SpinLock-In-Linux/" data-id="cka8b3cix000hokv60hudas0y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/05/15/TCP-Three-Way-Handshake/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          TCP Three Way Handshake
        
      </div>
    </a>
  
  
    <a href="/2020/05/15/Fiber-In-Linux/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Fiber In Linux</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Structure/" rel="tag">Data Structure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Introduce-To-Algorithm/" rel="tag">Introduce To Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 13.33px;">C++</a> <a href="/tags/Data-Structure/" style="font-size: 13.33px;">Data Structure</a> <a href="/tags/Introduce-To-Algorithm/" style="font-size: 16.67px;">Introduce To Algorithm</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 10px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/30/Letters-and-Numbers/">Letters and Numbers</a>
          </li>
        
          <li>
            <a href="/2020/05/28/Count-Sort/">Count Sort</a>
          </li>
        
          <li>
            <a href="/2020/05/27/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1IPC/">进程间通信IPC</a>
          </li>
        
          <li>
            <a href="/2020/05/26/Quick-Sort/">Quick Sort</a>
          </li>
        
          <li>
            <a href="/2020/05/24/Heap-Sort/">Heap-Sort</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 BeeCaffe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>